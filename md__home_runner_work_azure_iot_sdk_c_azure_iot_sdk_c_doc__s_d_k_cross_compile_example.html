<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Azure IoT C SDK: Cross Compiling the Azure IoT Hub SDK</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Azure IoT C SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Cross Compiling the Azure IoT Hub SDK </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md142"></a>
Background</h1>
<p>The SDK for the Azure IoT Hub was written to use the C99 standard in order to retain a high level of compatibility with hardware platforms that have not yet seen an official release of the SDK. This should ease the burden of porting the SDK code to those platforms.</p>
<p>One of the challenges that might be encountered though is that the platform in question is not capable of building the code. Many such platforms may require that the executables are compiled on a host with a different chipset architecture from its own. This process of building executables on a host to target a disparate platform is known as cross compiling.</p>
<h1><a class="anchor" id="autotoc_md143"></a>
Purpose of this document</h1>
<p>This document presents an example of how to cross compile the Azure IoT Hub SDK using the make system, <a href="https://cmake.org">cmake</a>, that is employed by the project. In this example it will demonstrate the process of cross compiling the SDK on a Debian 64-bit system targeting a Raspberry Pi. It demonstrates how one must set up the file system and the cmake options to achieve this which should assist developers attempting to cross compile for other targets.</p>
<h1><a class="anchor" id="autotoc_md144"></a>
Procedure</h1>
<h2><a class="anchor" id="autotoc_md145"></a>
Version Information</h2>
<p>The host machine is running Debian GNU/Linux 8 (jessie) amd64</p>
<p>The target machine is running Raspbian GNU/Linux 8 (jessie)</p>
<p><b>Note:</b> This example was built and tested on an <b>amd64</b> build of Debian on the host and will use the <b>64-bit version</b> of the Raspbian toolchain. You will need to select a different target toolchain if your host is not running a 64-bit Linux operating system.</p>
<p>Though it may be possible to use a host machine running a variant of Windows this would likely be very complex to set up and thus is not addressed in this document.</p>
<h2><a class="anchor" id="autotoc_md146"></a>
Setting up the Build Environment</h2>
<p>Open a terminal prompt on your host machine in the manner you prefer.</p>
<p>We need to acquire the SDK source code. This is available in the <a href="https://github.com/Azure/azure-iot-sdk-c.git">C SDK GitHub repository</a>. We clone this too our host machine as follows:</p>
<div class="fragment"><div class="line">cd ~</div>
<div class="line">mkdir Source</div>
<div class="line">cd Source</div>
<div class="line">git clone https://github.com/Azure/azure-iot-sdk-c.git</div>
<div class="line">cd azure-iot-sdk-c</div>
<div class="line">git submodule update --init</div>
</div><!-- fragment --><p>Further information regarding this step and other set up requirements can be found in this <a href="https://github.com/Azure/azure-iot-sdk-c/blob/master/doc/devbox_setup.md">guide</a>. This step is only included in this document to establish the directory structure used for the rest of the example.</p>
<p>You might consider building the SDK for your local platform at this point simply to ensure you have all the required components. At the very least, you must ensure that the SDK's prerequisite libraries are installed on your Raspberry Pi. You can achieve this by running the script <em>setup.sh</em> found in <em>azure-iot-sdk-c/build_all/linux</em>.</p>
<p>In order to cross compile for a different target the first requirement is to set up an environment containing the required toolchain, system libraries and system headers that may be required to build the code. In the instance of the Raspberry Pi this is simplified by the existence of a GitHub project that has much of that work already done for us. Change to your home directory, create a new directory for the Raspberry Pi Tools and clone the project at <a href="https://github.com/raspberrypi/tools">https://github.com/raspberrypi/tools</a> into that directory. For example: </p><div class="fragment"><div class="line">cd ~</div>
<div class="line">mkdir RPiTools</div>
<div class="line">cd RPiTools</div>
<div class="line">git clone https://github.com/raspberrypi/tools.git</div>
</div><!-- fragment --><p> Unfortunately, this does not give us all the files that are required to build the project. At this point you will need to copy some files from a running Raspberry Pi to your host machine. Make sure you can access your Raspberry Pi via SSH (you can enable this using <a href="https://www.raspberrypi.org/documentation/configuration/raspi-config.md">raspi-config</a> and select "9. Advanced Options". Further instructions are beyond the scope of this document).</p>
<p>Make sure <a href="https://github.com/Azure/azure-iot-sdk-c/blob/LTS_07_2020_Ref01/build_all/linux/setup.sh#L12">these libraries</a> are installed in the Raspberry Pi before proceeding.</p>
<p>On your host's terminal enter: </p><div class="fragment"><div class="line">cd ~/RPiTools/tools/arm-bcm2708/\</div>
<div class="line">gcc-linaro-arm-linux-gnueabihf-raspbian-x64/arm-linux-gnueabihf</div>
<div class="line">rsync -rl --exclude &#39;/usr/lib/cups/backend/vnc&#39; --safe-links pi@&lt;your Pi identifier&gt;:/{lib,usr} .</div>
</div><!-- fragment --><p> In the above command replace &lt;<em>your Pi identifier</em>&gt; with the IP address of your Raspberry Pi. If you no longer have a user identity on your Raspberry Pi called pi, then you will need to substitute an existing user identity.</p>
<p>This command will copy many more files to your host than you actually need but, for brevity, we copy them all. If you wish, you could optimize the sync action to exclude files that are not required.</p>
<h2><a class="anchor" id="autotoc_md147"></a>
Setting up cmake to cross compile</h2>
<p>In order to tell cmake that it is performing a cross compile we need to provide it with a toolchain file. To save us some typing and to make our whole procedure less dependent upon the current user we are going to export a value. Whilst in the same directory as above enter the following command </p><div class="fragment"><div class="line">export RPI_ROOT=$(pwd)</div>
</div><!-- fragment --><p> You can use <em>export -p</em> to verify RPI_ROOT has been added to the environment.</p>
<p>Now we need to switch to the SDK directory tree. Enter this command </p><div class="fragment"><div class="line">cd ~/Source/azure-iot-sdk-c/build_all/linux</div>
</div><!-- fragment --><p> Using the text editor of your choice, create a new file in this directory and call it toolchain-rpi.cmake. Into this file place the following lines</p>
<div class="fragment"><div class="line">INCLUDE(CMakeForceCompiler)</div>
<div class="line"> </div>
<div class="line">SET(CMAKE_SYSTEM_NAME Linux)     # this one is important</div>
<div class="line">SET(CMAKE_SYSTEM_VERSION 1)     # this one not so much</div>
<div class="line"> </div>
<div class="line"># this is the location of the amd64 toolchain targeting the Raspberry Pi</div>
<div class="line">SET(CMAKE_C_COMPILER $ENV{RPI_ROOT}/../bin/arm-linux-gnueabihf-gcc)</div>
<div class="line"> </div>
<div class="line"># this is the file system root of the target</div>
<div class="line">SET(CMAKE_FIND_ROOT_PATH $ENV{RPI_ROOT})</div>
<div class="line"> </div>
<div class="line"># search for programs in the build host directories</div>
<div class="line">SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)</div>
<div class="line"> </div>
<div class="line"># for libraries and headers in the target directories</div>
<div class="line">SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)</div>
<div class="line">SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)</div>
</div><!-- fragment --><p> and save the toolchain file. Your cross compilation environment is now complete.</p>
<h2><a class="anchor" id="autotoc_md148"></a>
Building the SDK</h2>
<p>The final step in the process is to run the actual build. For this you will need to be in the Linux build directory as shown above. Enter the following commands </p><div class="fragment"><div class="line">cd ~/Source/azure-iot-sdk-c/build_all/linux</div>
<div class="line">./build.sh --toolchain-file toolchain-rpi.cmake -cl --sysroot=$RPI_ROOT</div>
</div><!-- fragment --><p> This will tell cmake to build the SDK using the toolchain file toolchain-rpi.cmake. Finally, and absolutely critical is the use of the <em>&ndash;sysroot</em> option. Without this the compiler will fail to find required headers and libraries.</p>
<h2><a class="anchor" id="autotoc_md149"></a>
Specifying Additional Build Flags</h2>
<p>If you need to provide additional build flags for your cross compile to function you can add further <em>-cl</em> parameters to the build script's command line. For example, adding <em>-cl -v</em> will turn on the verbose output from the compile and link process or to pass options only to the linker for example to pass -v to the linker you can use <em>-cl Wl,-v</em>.</p>
<p>See this page for a summary of available gcc flags: <a href="https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html">https://gcc.gnu.org/onlinedocs/gcc/Option-Summary.html</a>.</p>
<h2><a class="anchor" id="autotoc_md150"></a>
Notes</h2>
<p>These instructions have been tested on both the Raspberry Pi 2, 3 and 4.</p>
<h2><a class="anchor" id="autotoc_md151"></a>
Known Issues and Circumventions</h2>
<p>If you encounter the error <em>error adding symbols: DSO missing from command line</em> try adding a reference to libdl with <em>-cl -ldl</em> added to your build script command line.</p>
<p>For Raspberry Pi 4 the following workaround is necessary to properly link the samples with pthread. Run the following commands and <a href="#Building-the-SDK">recompile the Azure IoT C SDK</a>.</p>
<div class="fragment"><div class="line">cd $RPI_ROOT/usr/lib/arm-linux-gnueabihf; </div>
<div class="line">ln -s ../../../lib/arm-linux-gnueabihf/libpthread.so.0 libpthread.so</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md152"></a>
Summary</h1>
<p>This document has demonstrated how to cross compile the Azure IoT SDK on a 64-bit Debian host targeting the Raspbian operating system.</p>
<h1><a class="anchor" id="autotoc_md153"></a>
References</h1>
<p><a href="https://github.com/Azure/azure-iot-sdks">https://github.com/Azure/azure-iot-sdks</a></p>
<p><a href="https://github.com/Azure/azure-iot-sdks/blob/master/c/doc/devbox_setup.md">https://github.com/Azure/azure-iot-sdks/blob/master/c/doc/devbox_setup.md</a></p>
<p><a href="https://github.com/raspberrypi/tools">https://github.com/raspberrypi/tools</a></p>
<p><a href="https://cmake.org/Wiki/CMake_Cross_Compiling">https://cmake.org/Wiki/CMake_Cross_Compiling</a></p>
<p><a href="https://www.raspberrypi.org">https://www.raspberrypi.org</a></p>
<p><a href="http://stackoverflow.com/questions/19162072/installing-raspberry-pi-cross-compiler">http://stackoverflow.com/questions/19162072/installing-raspberry-pi-cross-compiler</a> (See answer) </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.0
</small></address>
</body>
</html>
