<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Azure IoT C SDK: Threading model and optimizing for resource constrained devices</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Azure IoT C SDK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Threading model and optimizing for resource constrained devices </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md163"></a>
IoTHub Device Client and the _LL_ (lower layer) API</h1>
<h2><a class="anchor" id="autotoc_md164"></a>
The lower layer</h2>
<p>There are two distinct but closely related sets of APIs for the IoTHub client. Applications that want to run on a single thread should use the _LL_ (aka lower level) API. Sometimes the hardware/OS can only support one thread at a time or else spinning additional threads is expensive. Applications on more capable hardware may also use the _LL_ layer for greater control over scheduling.</p>
<p>Calls to the IoThub API's ending in Async do not cause the operation to execute immediately. Instead, the work - both for sending data across the network and receiving data - is queued. The application must manually schedule the work by calling <code>IoTHubDeviceClient_LL_DoWork</code> (when using a device client).</p>
<p>This is typically done in some sort of simple loop, e.g.</p>
<div class="fragment"><div class="line">IOTHUB_DEVICE_CLIENT_LL_HANDLE iotHubLLHandle;</div>
<div class="line"> </div>
<div class="line"><span class="keywordflow">while</span> (appIsRunning) {</div>
<div class="line">    SendTelemetryIfThereIsAnyToSend(iotHubLLHandle);</div>
<div class="line">    <a class="code" href="iothub__device__client__ll_8h.html#a6e77da5502dff2bb43bace5173242f37">IoTHubDeviceClient_LL_DoWork</a>(iotHubLLHandle);</div>
<div class="line">    Sleep(1000);</div>
<div class="line">}</div>
<div class="ttc" id="aiothub__device__client__ll_8h_html_a6e77da5502dff2bb43bace5173242f37"><div class="ttname"><a href="iothub__device__client__ll_8h.html#a6e77da5502dff2bb43bace5173242f37">IoTHubDeviceClient_LL_DoWork</a></div><div class="ttdeci">void IoTHubDeviceClient_LL_DoWork(IOTHUB_DEVICE_CLIENT_LL_HANDLE iotHubClientHandle)</div><div class="ttdoc">This function MUST be called by the user so work (sending/receiving data on the network,...</div></div>
</div><!-- fragment --><p><b>CRITICAL(!) notes for _LL_ application development</b> <br  />
 <em>NOT FOLLOWING THESE STEPS WILL POTENTIALLY RESULT IN VERY HARD TO DIAGNOSE BUGS</em></p>
<ul>
<li>You <b>MUST NOT</b> use an _LL_ handle on more than one thread (unless you provide <em>all</em> your own locking). Part of what makes the _LL_ layer use fewer resources is that it does not use locks. It assumes a single threaded environment where locks are not needed.</li>
<li>Even if you are not actively sending data while using _LL_ layer, you still need to periodically invoke the appropriate <code>DoWork</code> to make the client accept data from the network. This periodic <code>DoWork</code> call is also required as otherwise the underlying network transport and/or service may timeout the service due to inactivity.</li>
</ul>
<h2><a class="anchor" id="autotoc_md165"></a>
The convenience layer</h2>
<p>Applications may also use the non _LL_ API set, which is also known as the "convenience layer." <br  />
</p>
<p>Just like the _LL_ layer, IoTHub API's ending in Async queue work to be performed later and do not block waiting for the service accepting or rejecting the request. The difference is that the convenience layer itself automatically takes care of sending the data. In other words, there is no <code>DoWork</code>. The convenience layer does this for you automatically by spinning a worker thread to implicitly <code>DoWork</code> for your application. The convenience layer also performs locking, allowing a given <code>IOTHUB_DEVICE_CLIENT_HANDLE</code> to be safely used by different threads.</p>
<h1><a class="anchor" id="autotoc_md166"></a>
How to specify between the _LL_ and convenience layers</h1>
<ul>
<li>Applications using the _LL_ layer should <code>#include <a class="el" href="iothub__device__client__ll_8h.html" title="APIs that allow a user (usually a device) to communicate with an Azure IoTHub.">iothub_device_client_ll.h</a></code> and use its API's and <code>IOTHUB_DEVICE_CLIENT_LL_HANDLE</code>.</li>
<li>Applications using the convenience layer should <code>#include <a class="el" href="iothub__device__client_8h.html" title="Extends the IoTHubCLient_LL with additional features.">iothub_device_client.h</a></code> and use its API's and <code>IOTHUB_DEVICE_CLIENT_HANDLE</code>.</li>
</ul>
<p>The _LL_ | convenience layer paradigm is used in many places throughout the SDK. The module client follows this pattern with <code>IOTHUB_MODULE_CLIENT_LL_HANDLE</code> and <code>IOTHUB_MODULE_CLIENT_HANDLE</code>. The provisioning client also follows this pattern with <code>PROV_DEVICE_LL_HANDLE</code> and <code>PROV_DEVICE_HANDLE</code>.</p>
<h1><a class="anchor" id="autotoc_md167"></a>
Avoid long-running callbacks</h1>
<p>Regardless of whether you are using the _LL_ or convenience layer, application callbacks that you implement - such as processing a twin update - must NOT block for extended periods of time. <br  />
</p>
<p>The IoTHub SDK uses a single dispatcher thread to handle all callbacks to user code. This same thread handles all network I/O. This is true whether the _LL_ or convenience layer is used. The only difference is that in the _LL_ layer, your thread is the dispatcher when it calls into the appropriate DoWork() call.</p>
<p>An application callback that takes a long time to run is problematic. The SDK will not be able to call other pending callbacks as it is blocked on the long-running one. If the call back code takes long enough (minutes) there is the risk that the SDK will not be able to fire its periodic network keep-alive and that the entire connection will be dropped. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.0
</small></address>
</body>
</html>
